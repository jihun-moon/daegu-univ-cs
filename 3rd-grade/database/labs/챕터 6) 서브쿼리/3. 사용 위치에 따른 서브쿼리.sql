-- [조건절에서 사용하는 서브쿼리]
-- 목적: 각 도시별 평균 마일리지가 전체 고객 평균 마일리지보다 높은 도시만 조회
-- 핵심: HAVING 절 안에서 전체 평균을 계산하는 서브쿼리를 사용
SELECT 도시,
	   AVG(마일리지) AS 평균마일리지
FROM 고객
GROUP BY 도시
HAVING AVG(마일리지) > (
					 SELECT AVG(마일리지)
					 FROM 고객
                     );
					
/*
[예상 결과]
---------------------------------------
| 도시       | 평균마일리지           |
---------------------------------------
| 서울특별시 | 7,200                 |
| 부산광역시 | 6,500                 |
---------------------------------------
(전체 고객 평균마일리지 6,000보다 높은 도시)
*/
    
-- [FROM절에서 사용하는 서브쿼리 (인라인 뷰)]
-- 목적: 고객별 마일리지와 동일 도시의 평균 마일리지를 한 번에 조회
-- 핵심: FROM (SELECT …) AS 별칭 구문을 통해 작은 뷰(View)처럼 활용
SELECT 담당자명,
	   고객회사명,
	   마일리지,
       고객.도시,
       도시_평균마일리지,
       도시_평균마일리지 - 마일리지 AS 차이
FROM 고객,
	 (SELECT 도시,
		     AVG(마일리지) AS 도시_평균마일리지
     FROM 고객
     GROUP BY 도시
     ) AS 도시별요약
WHERE 고객.도시 = 도시별요약.도시;

/*
[예상 결과]
------------------------------------------------------------------------------------
| 담당자명 | 고객회사명 | 마일리지 | 도시       | 도시_평균마일리지 | 차이     |
------------------------------------------------------------------------------------
| 홍길동   | ABC Corp   | 8,000    | 서울특별시 | 7,200            | -800     |
| 김철수   | XYZ Inc    | 6,500    | 부산광역시 | 6,500            | 0        |
------------------------------------------------------------------------------------
*/

-- [SELECT절에서 사용하는 서브쿼리]
-- 목적: 고객별로 가장 최근(최대) 주문일을 컬럼으로 함께 조회
-- 핵심: SELECT (SELECT MAX(...) …) AS 별칭 형태로 한 행당 하나의 값을 반환
SELECT 고객번호,
	   담당자명,
       (SELECT MAX(주문일)
        FROM 주문
        WHERE 주문.고객번호 = 고객.고객번호
       ) AS 최종주문일
FROM 고객;

/*
[예상 결과]
------------------------------------------
| 고객번호 | 담당자명 | 최종주문일       |
------------------------------------------
| C001     | 홍길동   | 2024-12-01       |
| C005     | 이순신   | 2025-03-15       |
------------------------------------------
*/

-- [CTE(Common Table Expression) 사용 예제]
-- 목적: WITH 절로 먼저 도시별 평균마일리지를 계산한 뒤,
--       메인 쿼리에서 고객별 마일리지 차이 계산
-- 핵심: CTE를 이용해 가독성 높은 단계별 쿼리 작성
WITH 도시별요약 AS
	(
	SELECT 도시,
		   AVG(마일리지) AS 도시_평균마일리지
	FROM 고객
	GROUP BY 도시
    )
    
SELECT 담당자명,
	   고객회사명,
	   마일리지,
       고객.도시,
       도시_평균마일리지,
       도시_평균마일리지 - 마일리지 AS 차이
FROM 고객, 
	 도시별요약
WHERE 고객.도시 = 도시별요약.도시;

/*
[예상 결과]
------------------------------------------------------------------------------------
| 담당자명 | 고객회사명 | 마일리지 | 도시       | 도시_평균마일리지 | 차이     |
------------------------------------------------------------------------------------
| 홍길동   | ABC Corp   | 8,000    | 서울특별시 | 7,200            | -800     |
| 김철수   | XYZ Inc    | 6,500    | 부산광역시 | 6,500            | 0        |
------------------------------------------------------------------------------------
*/

